# 要件定義書

AI 記事自動生成・WordPress自動投稿システム（キーワード戦略JSON版）

---

## 1. システム概要

本システムは、以下を自動化するための Web アプリケーションである。

* 事前に設定した **キーワード戦略（JSON）** と **記事タイプ（内容パターン）** を基に
* AI（主に Gemini 3 Pro）で記事本文を生成し
* 必要に応じて画像も生成した上で
* WordPress サイトへ自動投稿する

運用者は、ログイン可能な管理画面から以下を行う：

* 会社情報・サイト設定の管理
* 投稿プロファイル（種類）の管理
* キーワード戦略（JSON）の管理
* 記事タイプ（内容パターン）の管理
* スケジュール実行の設定
* 実行ログ（ジョブ単位・記事単位）の確認

---

## 2. 前提条件・制約

* **ユーザー / 会社 / WordPressサイト** は 1:1:1 とする

  * 1ユーザー = 1社 = 1サイト
* WordPress との連携は **REST API + Application Password** を用いる
* 使用するモデルは主に **Gemini 3 Pro**（テキスト生成＋必要に応じて画像生成）
* インフラは **GCP** 上で完結させる

  * Cloud Run（アプリケーション & バッチ）
  * Cloud SQL for PostgreSQL（DB）
  * Secret Manager（APIキー・WPパスワード）
  * Cloud Scheduler（定期実行トリガ）
  * Cloud Logging / Monitoring（ログ・監視）
* 想定利用者は開発者/運営者 1〜数名の **社内ツール** 的利用
* マルチテナント（複数社・複数サイト対応）は現時点ではスコープ外（将来拡張）

---

## 3. 機能一覧

1. ログイン・認証機能
2. 会社・WordPress サイト設定管理
3. 投稿プロファイル（種類）管理
4. **キーワード戦略（JSON）管理**
5. 記事タイプ（内容パターン）管理
6. スケジュール管理
7. 記事生成・WordPress 自動投稿（手動 / 自動）
8. 実行ログ閲覧（ジョブ単位 / 記事単位）

---

## 4. 機能要件

### 4.1 認証・ユーザー管理

**目的**
システムへのアクセスを制限し、設定や生成ログを安全に管理する。

**要件**

* メールアドレス + パスワードによるログイン機能を提供する
* パスワードはハッシュ化して保存する（例：bcrypt）
* ログイン・ログアウト機能を提供する
* ロールは単一（管理者）とし、詳細な権限管理は v1 のスコープ外とする

---

### 4.2 会社・サイト設定管理（Company）

**目的**
記事内に反映する会社情報と、投稿先 WordPress サイトの接続情報を一元管理する。

**管理項目**

* 会社情報

  * 会社名（正式名称）
  * ブランド名
  * 会社紹介文（記事末尾などに利用可能なテキスト）
  * 自社サイト URL
  * 問い合わせ / LP URL
* WordPress サイト設定（1社 = 1サイト）

  * WordPress ベースURL（例：`https://example.com`）
  * REST API 用ユーザー名
  * Application Password を格納している Secret Manager のキー名
  * デフォルト投稿ステータス（例：`draft` / `publish`）

**機能要件**

* 管理画面から上記項目の閲覧・編集ができること
* WordPress との接続テスト機能を提供すること

  * 認証情報を用いて `/wp-json/wp/v2/posts` 等へ簡易アクセスし、成功/失敗を表示する

---

### 4.3 投稿プロファイル管理（Post Profile = 「種類」）

**目的**
「どのカテゴリに」「どんな方針で」記事を出していくかをまとめた単位として管理する。

**イメージ**

* 例：

  * 「AI 自動化ブログ用」
  * 「美容サロン向けマーケ記事」
* 各プロファイルに対して：

  * WordPress カテゴリ
  * キーワード戦略（JSON）
  * 記事タイプ
  * スケジュール
    を紐づける。

**管理項目**

* プロファイル名（例：AI開発ナレッジブログ）
* 説明（内部用メモ）
* 紐づく WordPress カテゴリID
* 有効 / 無効フラグ
* キーワード戦略 JSON（後述 4.4）

**機能要件**

* プロファイル一覧の表示
* プロファイルの新規作成 / 編集 / 削除
* 有効 / 無効の切り替え
* 1社に対して複数の投稿プロファイルを設定できること

---

### 4.4 キーワード戦略管理（JSON形式）

**目的**
各投稿プロファイルごとに、SEO戦略の全体像と、狙いたいキーワード群を構造化して管理する。

**想定 JSON 形式（例）**

```json
{
  "strategy_concept": "SEO戦略の全体像と、どの層を最優先で狙うべきかの解説",
  "head_middle": ["...", "..."],
  "transactional_cv": ["...", "...", "..."],
  "informational_knowhow": ["...", "..."],
  "business_specific": ["...", "..."]
}
```

**フィールドの意味（例）**

* `strategy_concept`

  * SEO戦略全体の方向性や、優先して狙うべきユーザー層の説明。
  * LLMプロンプト内で「この記事の狙い」を共有するために使用。
* `head_middle`

  * ビッグ〜ミドルキーワード系のリスト。
* `transactional_cv`

  * CV（問い合わせ・申込など）に近い意図を持つキーワード群。
* `informational_knowhow`

  * ノウハウ・解説系キーワード群。
* `business_specific`

  * そのビジネス固有のキーワード（指名キーワードやニッチワード）。

**機能要件**

* 投稿プロファイル編集画面にて、`keyword_strategy` を編集できること。

  * 実装例：

    * JSONテキストエディタとして直接編集
    * または、`transactional_cv` / `informational_knowhow` などを別々のフォーム項目として入力し、サーバ側で JSON にまとめて保存
* JSONは DB で **JSONB** として保存すること。
* 保存時に以下を検証すること：

  * 有効な JSON であること（パース可能）
  * 必須キー（少なくとも `strategy_concept`）の存在チェック

---

### 4.5 記事タイプ管理（Article Type = 内容パターン）

**目的**
同じキーワード戦略のもとでも、「失敗5選」「事例集」「HowTo」など複数の内容パターンを使い分けられるようにする。

**例**

* 「AIのよくある失敗5選」
* 「AI活用事例」
* 「AI導入のステップガイド」
* 「Q&A / FAQ 形式」

**管理項目**

* 紐づく投稿プロファイル
* 記事タイプ名（例：AIのよくある失敗5選）
* 説明（管理画面向け）
* `prompt_template`

  * LLM に渡すテンプレートテキスト
  * 記事構成、見出しルール、文体、制約条件などを含める
* `is_enabled`（有効 / 無効）

**機能要件**

* プロファイルごとの記事タイプ一覧の表示
* 記事タイプの新規作成 / 編集 / 削除
* `is_enabled = true` の記事タイプのみを記事生成対象とすること

**生成時の利用イメージ**

* 対象の投稿プロファイルに紐づく記事タイプの中から、`is_enabled = true` のものを取得し、その中から 1つ選択して LLM プロンプトに組み込む。

---

### 4.6 スケジュール管理（Post Profile Schedule）

**目的**
各投稿プロファイルごとに「いつ自動実行するか」を設定する。

**前提**

* 各投稿プロファイルに対して **スケジュールは 1 つ（1-1）** とする。
* 「スケジュールなし」「毎日」「毎週」「cron 形式」などを想定。

**管理項目（例）**

* 紐づく投稿プロファイルID
* スケジュール種別：`none` / `daily` / `weekly` / `cron`
* `daily_time`：毎日実行する時刻（`daily` 用）
* `weekly_day_of_week`：毎週実行する曜日（1=Mon〜7=Sun など）
* `weekly_time`：毎週実行する時刻
* `cron_expression`：cron形式の文字列（高度なスケジュールが必要な場合）
* `is_enabled`：スケジュールを有効にするかどうか

**機能要件**

* 各投稿プロファイルに対してスケジュール設定画面を提供する。
* 「スケジュールなし（手動のみ）」「毎日」「毎週」「cron」などを選択できる。
* `is_enabled` によって一時的な停止 / 再開が可能であること。
* 実行ロジック：

  * Cloud Scheduler は一定間隔（例：1〜5分毎）で Cloud Run のバッチ用エンドポイントを呼び出す。
  * バッチ処理側で現在時刻と `post_profile_schedules` を照合し、実行対象プロファイルを決定する。

---

### 4.7 記事生成・WordPress 自動投稿

**目的**
設定されたプロファイル・キーワード戦略・記事タイプに基づき、記事生成から WordPress 投稿までを自動化する。

**実行単位**

* **Job（ジョブ）**：1回のバッチ実行（1つの投稿プロファイルに対する実行）
* **Job Item**：1つの Job の中で生成された「記事1本」

**記事生成フロー（1記事）**

1. 対象となる投稿プロファイルを決定する。
2. 対象プロファイルの `keyword_strategy`（JSON）を読み込む。
3. ルールに基づき、使用するキーワード文字列を選択する。
   例：

   * CV獲得フェーズでは `transactional_cv` 配列から1件ランダムに選択。
   * 学習フェーズでは `informational_knowhow` から選択。
4. 対象プロファイルの `post_profile_article_types` から、`is_enabled = true` の記事タイプを取得し、その中から1件選択する。
5. Gemini 3 Pro に渡すプロンプトを構築する：

   * 会社情報（Company）
   * 投稿プロファイル情報
   * `keyword_strategy.strategy_concept`（戦略の説明）
   * 選択されたキーワード文字列
   * 選択された記事タイプの `prompt_template`
6. LLM により、記事本文・タイトル・必要なメタ情報を生成する。
7. 必要に応じて画像生成APIを呼び出し、アイキャッチ画像等を生成する。
8. WordPress REST API を用いて投稿を行う：

   * 画像がある場合は `/wp/v2/media` にアップロードし、`featured_media` として利用。
   * `/wp/v2/posts` に対してタイトル・本文・カテゴリ・ステータスなどを送信。
9. 実行結果（成功 / 失敗、WordPress Post ID / URL など）を Job Item に記録する。

**手動実行**

* 管理画面上で「このプロファイルを今すぐ実行」ボタンを提供し、押下時にJobを1件起動する。

**自動実行**

* 4.6 のスケジュール管理と Cloud Scheduler により、設定時刻に自動で Job を起動する。

---

### 4.8 実行ログ・監査（Jobs & Job Items）

**目的**
いつ・どのプロファイルで・どのようなキーワード・記事タイプを利用して記事を生成し、結果がどうだったかを追跡できるようにする。

**Job（ジョブ単位）**

* 管理項目（例）：

  * 対象投稿プロファイルID
  * 実行トリガ種別：`manual` / `scheduler`
  * ステータス：`running` / `success` / `partial_failed` / `failed`
  * 実行開始時刻 `started_at`
  * 実行終了時刻 `finished_at`
  * ジョブ全体に関するエラーメッセージ（必要に応じて）

**Job Item（記事単位）**

* 管理項目（例）：

  * 紐づく Job ID
  * 対象投稿プロファイルID
  * 使用した記事タイプID
  * 使用したキーワード文字列（JSONから選択されたもの）
  * 生成された記事タイトル
  * WordPress Post ID / URL
  * ステータス：`success` / `failed`
  * エラーメッセージ（記事単位）
  * 作成日時

**機能要件**

* Job 一覧画面で、実行日時・プロファイル・ステータスを確認できること。
* 特定の Job の詳細画面で、Job Items（記事ごとの結果）を一覧できること。
* 失敗した Job / Job Item のエラーメッセージを確認できること。

---

## 5. 非機能要件（概要）

### 5.1 セキュリティ

* パスワードはハッシュ化して保存する（平文保存は禁止）。
* 外部APIキーや WordPress Application Password は Secret Manager で管理する。
* Cloud SQL は認証付き接続（Private IP または Cloud SQL Auth Proxy）を用いる。

### 5.2 可用性・性能

* 管理画面およびバッチ処理は Cloud Run 上で稼働させる。
* 想定記事数は 1日数本〜数十本程度とし、必要に応じて Cloud Run の自動スケールアウトで対応する。

### 5.3 ロギング・監視

* アプリケーションログは Cloud Logging に集約する。
* ジョブ失敗が一定回数以上続いた場合などのアラート設定は、将来的な拡張とする。

---

## 6. 将来拡張候補（v2以降）

* キーワード戦略 JSON の自動生成・自動提案機能
* キーワードごとの成果（トラフィック・CV）の集計・可視化
* 複数サイト・複数会社を管理するマルチテナント対応
* 内部リンク構造・カテゴリ構造の最適化支援
* 複数 LLM / 画像モデルの切り替え・ABテスト機能
